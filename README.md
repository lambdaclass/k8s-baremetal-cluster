# Kubernetes cluster

## Requirements

- [Terraform >= 0.12](https://www.terraform.io/downloads.html)
- [Python 3](https://www.python.org/downloads/)
- [Pipenv](https://pipenv-fork.readthedocs.io/en/latest/)
- [Kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/)
- Scaleway account (this can be changed to any other provider in Terraform configuration)

Optionally, you can install [Helm](https://helm.sh), a package manager for Kubernetes.

## Setup

Set the following environment variables:

- `TF_VAR_organization`: Your Scaleway organization ID
- `TF_VAR_token`: Your Scaleway API access token, generated by you
- `TF_VAR_ssh_key`: Your _public_ SSH key to access provisioned servers
- `TF_VAR_ssh_name`: A name of your choice to associate to your SHH key
- `TF_VAR_region`: (OPTIONAL) The Scaleway region, by default `fr-par`
- `TF_VAR_zone`: (OPTIONAL) The Scaleway zone, by default `fr-par-1`
- `TF_VAR_instance_type`: (OPTIONAL) The Scaleway Baremetal server type, by default `C2S`

If you are using (or want) a different provider please check their corresponding documentation on how to setup for it at [Terraform Providers](https://www.terraform.io/docs/providers/index.html).

## Usage
### Setting up the infrastructure

```
$> make infra
```

This wil setup your servers using the terraform configuration. By default, there will be one master server and two workers; if you wish to change these numbers, say you want 2 masters and 4 workers, simply pass them as variables like so:

```
$> make infra MASTERS=2 WORKERS=4
```

Terraform will then ask for confirmation, type `yes` to continue.

```
Plan: 8 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes
```

When finished, terraform will output the IPs of the servers:

```
Outputs:

k8s_master_public_ip = [
  "kube-master-1",
  "192.168.0.101",
]
worker_public_ips = [
  "kube-worker-1",
  "192.168.0.102",
]
```

### Preparing the servers

Setup the environment required to install kubernetes and all other dependencies:

```
$> make init
```

[Kubespray](https://kubernetes.io/docs/setup/production-environment/tools/kubespray/) copies your ssh key to all the servers specified in the inventory. You can pass the path to your key by setting the environment variable `SSH_KEY` (by default, will be set to `$HOME/.ssh/id_rsa`).  
To install Kubernetes execute the following command (and grab a cup of â˜•):

```
$> make cluster
```

After Kubespray finishes provisioning the servers, you can access the cluster by copying the cluster config to `$HOME/.kube/config`:

```
$> cp inventory/artifacts/admin.conf ~/.kube/config
```

You should have access to the cluster via `kubectl`:

```
$> kubectl cluster-info
Kubernetes master is running at https://192.168.0.101:6443
coredns is running at https://192.168.0.101:6443/api/v1/namespaces/kube-system/services/coredns:dns/proxy
kubernetes-dashboard is running at https://192.168.0.101:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy
```

You can then apply the manifests in the `k8s-manifests` folder. They create an `admin` ServiceAccount and provide it with an elevated ClusterRoleBinding.

```
$> kubectl apply -f k8s-manifests/ --recursive
```

To access the dashboard, first get the service account token:

```
$> kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin | awk '{print $1}')
```

Then you start a proxy:

```
$> kubectl proxy
```

and open
http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/#!/login

To reset the cluster and remove Kubernetes:

```
$> make reset
```

If needed, tear the whole infrastructure down:

```
$> make destroy
```
